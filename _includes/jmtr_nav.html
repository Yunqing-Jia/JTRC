<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
  {% for section in site.data.jmtr %}
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-{{forloop.index}}" aria-expanded="false" aria-controls="collapse-{{forloop.index}}">
            {{ section.title }}
          </a>
        </h4>
      </div>

      {%- assign collapsed = true -%}
      {%- for item in section.jmtr -%}
        {%- assign item_url = item.name | prepend:"/jmtr/" | append:"/" -%}
        {%- if item_url == page.url -%}
          {%- assign collapsed = false -%}
        {%- endif -%}
        {%- if item.subpage -%}
          {%- for sub in item.subpage -%}
            {%- assign sub_url = sub | prepend:"/jmtr/" | append:"/" -%}
            {%- if sub_url == page.url -%}
              {%- assign collapsed = false -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}

      <div class="panel-collapse{% if collapsed %} collapse{% endif %}" id="collapse-{{forloop.index}}" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          {% for item in section.jmtr %}
            {%- assign item_url = item.name | prepend:"/jmtr/" | append:"/" -%}
            {%- assign p = site.jmtr | where:"url", item_url | first -%}

            {%- assign active_sub = false -%}
            {%- if item.subpage -%}
              {% for sub in item.subpage %}
                {% assign sub_url = sub | prepend:"/jmtr/" | append:"/" %}
                {% if sub_url == page.url %}
                  {% assign active_sub = true %}
                {% endif %}
              {% endfor %}
            {%- endif -%}

            <div class="parent-with-sub">
              <a class="list-group-item d-flex align-items-center has-sub {% if item_url == page.url or active_sub %}active{% endif %}" href="javascript:void(0);" onclick="toggleSubmenu(this)">
                <span class="submenu-caret {% if active_sub %}rotated{% endif %}">&#9656;</span>
                <span style="margin-left: 5px;">{{ p.title }}</span>
              </a>

              {% if item.subpage %}
                <div class="subpage-group" style="{% unless active_sub %}display: none;{% endunless %}">
                  {% for sub in item.subpage %}
                    {% assign sub_url = sub | prepend:"/jmtr/" | append:"/" %}
                    {% assign p_sub = site.jmtr | where:"url", sub_url | first %}
                    <a class="list-group-item {% if sub_url == page.url %}active{% endif %}" style="padding-left: 30px;" href="{{ p_sub.url | relative_url }}">{{ p_sub.title }}</a>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

          {% endfor %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<script>
  function toggleSubmenu(element) {
    const caret = element.querySelector(".submenu-caret");
    const subGroup = element.parentElement.querySelector(".subpage-group");

    if (subGroup) {
      const isVisible = subGroup.style.display !== "none";
      subGroup.style.display = isVisible ? "none" : "block";
      caret.classList.toggle("rotated", !isVisible);
    }
  }
</script>

<style>
  .submenu-caret {
    display: inline-block;
    transition: transform 0.3s ease;
  }
  .submenu-caret.rotated {
    transform: rotate(90deg);
  }
</style>